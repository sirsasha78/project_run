from rest_framework import serializers
from django.contrib.auth.models import User

from app_run.models import Run


class AthleteSerializer(serializers.ModelSerializer):
    """Сериализатор для модели User, предназначенный для представления данных спортсмена.
    Используется для сериализации и десериализации данных пользователей,
    когда они выступают в роли спортсменов. Включает основные поля профиля:
    идентификатор, имя пользователя, фамилию и имя.
    Атрибуты:
        Meta (класс): Вложенный класс, определяющий модель и поля сериализатора."""

    class Meta:
        """Метакласс сериализатора, определяющий связь с моделью и поля для сериализации.
        Атрибуты:
            model (django.db.models.Model): Модель, с которой работает сериализатор.
            fields (tuple): Кортеж полей модели, которые будут включены в сериализацию.
        """

        model = User
        fields = ("id", "username", "last_name", "first_name")


class RunSerializer(serializers.ModelSerializer):
    """Сериализатор для модели Run.
    Преобразует объекты модели Run в формат JSON и обратно, обеспечивая
    сериализацию указанных полей модели. Используется для передачи данных о забегах
    через API. Включает вложенные данные спортсмена с помощью AthleteSerializer.
    Атрибуты:
        athlete_data (AthleteSerializer): Вложенный сериализатор для отображения
            данных спортсмена. Доступен только для чтения и автоматически
            заполняется данными связанного объекта Athlete."""

    athlete_data = AthleteSerializer(source="athlete", read_only=True)

    class Meta:
        """Метакласс сериализатора RunSerializer.
        Определяет модель Django и поля, которые будут сериализованы."""

        model = Run
        fields = ("id", "created_at", "athlete", "comment", "athlete_data")


class UserSerializer(serializers.ModelSerializer):
    """Сериализатор для модели User.
    Преобразует объекты модели User в формат JSON и обратно.
    Включает стандартные поля пользователя, а также вычисляемое поле `type`,
    которое определяет тип пользователя на основе его прав доступа:
    - 'coach' — если пользователь имеет статус персонала (is_staff=True),
    - 'athlete' — для всех остальных пользователей.
    Используется в API для предоставления информации о пользователях
    с различением по ролям без необходимости передачи служебных полей напрямую."""

    type = serializers.SerializerMethodField()

    class Meta:
        """Метакласс сериализатора, определяющий модель и поля для сериализации.
        Атрибуты:
            model (User): Модель, на основе которой строится сериализатор.
            fields (tuple): Кортеж полей модели, включаемых в сериализацию,
                           включая вычисляемое поле `type`."""

        model = User
        fields = ("id", "date_joined", "username", "last_name", "first_name", "type")

    def get_type(self, obj: User) -> str:
        """Возвращает тип пользователя на основе его статуса персонала.
        Метод используется для заполнения поля `type` в сериализованных данных.
        Определяет роль пользователя: тренер (coach) или спортсмен (athlete).
        Аргументы:
            obj (User): Экземпляр модели User, для которого определяется тип."""

        return "coach" if obj.is_staff else "athlete"
